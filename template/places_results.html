{% extends "index.html" %}

{% block content %}
<div class="container-search">
    <!-- Search form for places tab -->
    <form class="form-container" id="search-bar-form">
        <div class="form-group search_box" style="margin-left: 600px;">
            <input type="text" class="form-control wide_search" name="search-input" id="search-input" placeholder="Search...">
            <div class="search-results" id="search-results" style="display: none;">
                <ul></ul>
            </div>
        </div>
        <div class="form-group search_box">
            <button type="submit" class="btn btn-default">Go</button>
        </div>
    </form>
</div>
<div class="container-results">    
      <div class="row">
        <div class="col-md-7 filter_results_places_container" id="filter_results_places_container">
          <!-- Your search results go here -->
        </div>

        <div class="col-md-3 places_recommendations" style="background-color: transparent;" id="places_recommendations">
          <script>
            function isLoggedIn() {
              var sessionString = '{{ session|tojson }}';
              var sessionObj = JSON.parse(sessionString);
              if ('user' in sessionObj) {
                return true;
              }
              else{
                return false;
              }
            }

            function getUsername() {
              if(isLoggedIn()) {
                var sessionString = '{{ session|tojson }}';
                var sessionObj = JSON.parse(sessionString);
                return sessionObj['user']
              } else {
                return "";
              }
            }

            function displayPlacesRecommendations(results) {
              const createPlaceRecommendationCard = (result) => {
              let card = '<li class="list-group-item">';
              card += '<div class="row">';
              card += '<div class="col-md-7">';
              card += `<h4>${result.place}</h4>`;
              card += `<h5>${result.city}, ${result.state}</h5>`;    
              card += '</div>';
              card += '<div class="col-md-5">';
              card += createStarRating(result.rating, result.num_rating);  
              card += '</div>';
              card += '</div>';
              card += '</li>';
              return card;
            };

            let resultsHTML = '<h2>Places you might like</h2>';
            resultsHTML += '<ul class="list-group" style="height: 720px; overflow-y: scroll;">';
          
            results.forEach((result) => {
              resultsHTML += createPlaceRecommendationCard(result);
            });

            resultsHTML += '</ul>';

            const resultsContainer = document.getElementById('places_recommendations');
            resultsContainer.innerHTML = resultsHTML;
            }

            $.ajax({
              type: 'GET',
              url: '/get_places_recommendations',
              data: {'user': getUsername()},
              success: function(response) {
                var results = response.data;
                displayPlacesRecommendations(results);
              },
              error: function(error) {
                console.log(error);
              }
            });
          </script>
        </div>
      </div>
</div>
</div>

  <script>
  $(document).ready(function() {
    searchInputHandler('search-input', 'search-results', 'places', 'place');
  });
  </script>

  <script>
  // drop down search logic
  $(document).ready(function() {
    searchInputHandler('search-filter-input', 'search-filter-results');
  });
  </script>

  <script>
  // drop down search logic
  $(document).ready(function() {
    searchInputHandler('search-tag-filter-input', 'search-tag-filter-results');
  });
  
  $(document).on('click', '.dropdown-item', function() {
    var value = $(this).text();
    $('#search-tag-filter-input').val(value);
    $('#search-tag-filter-results').hide();
  });
  </script>

  <script>

    // jQuery event handler for hovering over a star
    $(document).on('mouseenter', '.rating-star-rate', function() {
      $(this).addClass('fas').removeClass('far');
      $(this).prevAll('.rating-star-rate').addClass('fas').removeClass('far');
      $(this).nextAll('.rating-star-rate').addClass('far').removeClass('fas');
    });

    // jQuery event handler for clicking on a star
    $(document).on('click', '.rating-star-rate', function() {
      const rating = $(this).data('value');
      const resultCard = $(this).closest('.list-group-item');
      const resultPlace = resultCard.data('place');
      const resultCity = resultCard.data('city');
      const resultState = resultCard.data('state');
      const resultRating = resultCard.data('rating');
      const resultNumRating = resultCard.data('num-rating');
      const resultInFavourite = resultCard.data('in-favourite');
      console.log('Selected rating:', rating);
      console.log('Result Place:', resultPlace);
      console.log('Result City:', resultCity);
      console.log('Result State:', resultState);
      console.log('Result Rating:', resultRating);
      console.log('Result Number of Ratings:', resultNumRating);
      console.log('Result In Favourites:', resultInFavourite);
      // TODO: Add code to submit rating to server or update UI
    });

    function addToFavoriteHandler(element) {
      const resultCard = $(element).closest('.list-group-item');
      const resultPlace = resultCard.data('place');
      const resultCity = resultCard.data('city');
      const resultState = resultCard.data('state');
      const resultRating = resultCard.data('rating');
      const resultNumRating = resultCard.data('num-rating');
      const resultInFavourite = resultCard.data('in-favourite');
      console.log('Result Place:', resultPlace);
      console.log('Result City:', resultCity);
      console.log('Result State:', resultState);
      console.log('Result Rating:', resultRating);
      console.log('Result Number of Ratings:', resultNumRating);
      console.log('Result In Favourites:', resultInFavourite);

      if (resultInFavourite) {
        $.ajax({
          type: 'POST',
          url: '/remove_from_favourite',
          data: {'place': resultPlace, 'cityname': resultCity, 'state': resultState},
          success: function(response) {
            if (response.data == 'success') {
              $(element).removeClass('fas').addClass('far');
              element.querySelector('div').textContent = 'Add to Favorites';
              resultCard.data('in-favourite', false);
              
            }
          },
          error: function(error) {
            console.log(error);
          }
        });
      } else {
        $.ajax({
          type: 'POST',
          url: '/add_to_favourite',
          data: {'place': resultPlace, 'cityname': resultCity, 'state': resultState},
          success: function(response) {
            if (response.data == 'success') {
              $(element).removeClass('far').addClass('fas');
              element.querySelector('div').textContent = 'Remove from Favorites';
              resultCard.data('in-favourite', true);
            }
          },
          error: function(error) {
            console.log(error);
          }
        }); 
      }
    }

    let search_query = null;
    let state = null;
    let city = null;

    function isLoggedIn() {
      var sessionString = '{{ session|tojson }}';
      var sessionObj = JSON.parse(sessionString);
      if ('user' in sessionObj) {
        return true;
      }
      else{
        return false;
      }
    }

    function getUsername() {
      if(isLoggedIn()) {
        var sessionString = '{{ session|tojson }}';
        var sessionObj = JSON.parse(sessionString);
        return sessionObj['user']
      } else {
        return "";
      }
    }
      
      // Function to display the search results on the page
      function displayResults(results) {
        const createResultCard = (result) => {
          let card = '<li class="list-group-item" ';
          card += `data-place="${result.place}" `;
          card += `data-city="${result.cityname}" `;
          card += `data-state="${result.state}" `;
          card += `data-rating="${result.rating}" `;
          card += `data-num-rating="${result.num_rating}" `;
          card += `data-in-favourite="${result.in_favourite}" `;
          card += '>';
          card += '<div class="row">';
          card += '<div class="col-md-4">';
          card += `<h4>${result.place}</h4>`;
          card += `<h5>${result.cityname}, ${result.state}</h5>`;    
          card += '</div>';
          card += '<div class="col-md-3">';
          card += createStarRating(result.rating, result.num_rating);  
          card += '</div>';
          card += '<div class="col-md-3" style="display: flex; align-items: center;">';
          card += createFavoriteButton(result.in_favourite, isLoggedIn(), 'addToFavoriteHandler(this)');
          card += '</div>';
          card += '<div class="col-md-2", style="display: flex; align-items: center;">';
          card += createRatingDropdown(isLoggedIn());
          card += '</div>';
          card += '</div>';
          card += '</li>';
          return card;
        };

        let resultsHTML = '<h2>Search Results</h2>';
        resultsHTML += '<ul class="list-group">';
      
        results.forEach((result) => {
          resultsHTML += createResultCard(result);
        });

        resultsHTML += '</ul>';

        const resultsContainer = document.getElementById('filter_results_places_container');
        resultsContainer.innerHTML = resultsHTML;
      }

      function searchPlacesResultsHandler() {

        // Display the filtered results
        // displayResults(filteredResults);
        $.ajax({
          type: 'GET',
          url: '/search_places',
          data: {'search_query': search_query, 'state': state, 'city': city, 'user': getUsername()},
          success: function(response) {
            var results = response.data;
            displayResults(results);
          },
          error: function(error) {
            console.log(error);
          }
        });
      }

      // Event listener for the search bar
      document.getElementById('search-bar-form').addEventListener('submit', (event) => {
        event.preventDefault();
        const queryParams = new URLSearchParams(window.location.search);
        queryParams.set('search_query', $('#search-input').val());
        window.location.href = `${"{{ url_for('places_results') }}"}?${queryParams.toString()}`;
      });
      search_query = "{{ search_query }}";
      state = "{{ state }}";
      city = "{{ city }}";
      searchPlacesResultsHandler();
      
  </script>

  <script>
    $(document).ready(function() {
      // get the height of .nav1
      var nav1Height = $('.nav1').height();
      var nav2Height = $('.nav2').height();

      // set the margin-top of .nav2 to the height of .nav1
      $('.container-search').css('margin-top', nav1Height + nav2Height + 'px');
    });
  </script>
{% endblock %}